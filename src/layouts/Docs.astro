---
import Layout from './Layout.astro';
import TableOfContents from '../components/TableOfContents';
import type { CollectionEntry } from 'astro:content';
import type { MarkdownHeading } from 'astro';
import { ChatConfigSchema } from '../schema/chat';

interface Props {
  entry: CollectionEntry<'docs'>;
  headings?: MarkdownHeading[];
}

const { entry } = Astro.props;
const { headings } = await entry.render();

// Get raw content from the slot
const rawContent = await Astro.slots.render('default');

// Create documentation-specific chat configuration
const docsSpecificConfig = ChatConfigSchema.parse({
  systemPrompt: [{
    type: "text" as const,
    text: "I am a documentation assistant. I help users understand the documentation and answer questions about it. I'll reference the current page content in my responses."
  }],
  welcome: {
    message: "üëã Need help with the documentation? I'm here to assist!",
    avatar: "/icon.svg",
    suggestions: [
      {
        label: "üìö Explain this page",
        prompt: "Can you explain what this documentation page is about?"
      },
      {
        label: "üîç Key concepts",
        prompt: "What are the key concepts covered in this section?"
      }
    ]
  }
});

const pageData = {
  title: entry.data.title,
  description: entry.data.description,
  type: "documentation",
  chatConfig: docsSpecificConfig,
  rightPanelMode: 'quarter' as const,
  content: rawContent
};
---

<script>
  declare global {
    interface Window {
      handleTocVisibility: (isVisible: boolean) => void;
    }
  }
  
  document.addEventListener('astro:page-load', () => {
    const main = document.querySelector('main');
    const tocContainer = document.getElementById('toc-container');
    
    // Set initial TOC width
    document.documentElement.style.setProperty('--toc-width', '16rem');
    
    window.handleTocVisibility = (isVisible: boolean) => {
      // Update TOC container
      if (tocContainer) {
        tocContainer.style.width = isVisible ? 'var(--toc-width)' : '0';
        tocContainer.style.opacity = isVisible ? '1' : '0';
      }
      
      // Update main content
      if (main) {
        // Ensure main content expands properly
        main.style.width = isVisible ? 'calc(100% - var(--toc-width))' : '100%';
        main.style.maxWidth = isVisible ? 'calc(100% - var(--toc-width))' : '100%';
      }
    };
  });
</script>

<Layout {...pageData}>
  <div class="lg:flex relative">
    <!-- Main Content -->
    <main class="flex-1 min-w-0 transition-all duration-300 ease-in-out w-full" transition:animate="none">
      <article class="py-8">
        <header class="mb-8">
          <div class="space-y-2">
            {entry.data.section && (
              <p class="text-sm font-medium text-muted-foreground">
                {entry.data.section}
              </p>
            )}
            <h1 class="text-3xl font-bold sm:text-4xl md:text-5xl">
              {entry.data.title}
            </h1>
            {entry.data.description && (
              <p class="text-lg sm:text-xl text-muted-foreground max-w-[750px]">
                {entry.data.description}
              </p>
            )}
          </div>
        </header>
        
        <div class="prose dark:prose-invert max-w-none">
          <slot />
        </div>
      </article>
    </main>

    <!-- Right Sidebar -->
    <div
      class="hidden lg:block flex-shrink-0 transition-all duration-300 ease-in-out overflow-hidden max-w-[240px]"
      id="toc-container"
      style="width: var(--toc-width)"
    >
      <div class="pt-4">
        <div class="pl-8 pr-4">
          <TableOfContents 
            headings={headings} 
            client:media="(min-width: 1024px)" 
          />
        </div>
      </div>
    </div>
  </div>
</Layout>